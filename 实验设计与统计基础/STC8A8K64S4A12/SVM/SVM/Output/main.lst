C51 COMPILER V9.59.0.0   MAIN                                                              06/18/2020 23:19:30 PAGE 1   


C51 COMPILER V9.59.0.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN ..\Output\main.obj
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE main.c LARGE OPTIMIZE(8,SPEED) BROWSE INCDIR(..\Lib;..\inc;..\Project) D
                    -EBUG OBJECTEXTEND PRINT(..\Output\main.lst) TABS(2) OBJECT(..\Output\main.obj)

line level    source

   1          #include  "delay.h"
   2          #include  "mpu6050.H" 
   3          #include  "uart.h"
   4          #include  "math.h"
   5          //// 用于显示6轴数据，实际使用时可以注释掉
   6          //int xdata zhengshu;
   7          //int xdata xiaoshu;
   8          //double xdata data_acc ;
   9          //double xdata data_gyro ;
  10          /**********************
  11          引脚别名定义
  12          ***********************/
  13          sbit rs=P3^2;        //1602的数据/指令选择控制线 
  14          sbit rw=P3^3;        //1602的读写控制线 
  15          sbit en=P3^4;        //1602的使能控制线 
  16          
  17          sbit key1=P7^4;
  18          sbit key2=P7^5;
  19          sbit key3=P7^6;
  20          sbit key4=P7^7;
  21          
  22          sbit led1=P1^6;
  23          double  gyro_data;
  24          double  acc_data;
  25          // 获取6轴数据
  26          double   acc_x_array[64];
  27          double   acc_y_array[64];
  28          double   acc_z_array[64];
  29          double   gyro_x_array[64];
  30          double   gyro_y_array[64];
  31          double   gyro_z_array[64];
  32          // body
  33          double  acc_body_x_array[64];
  34          double  acc_body_y_array[64];
  35          double  acc_body_z_array[64];
  36          // gravity
  37          //double   acc_gravity_x_array[64];
  38          //double   acc_gravity_y_array[64];
  39          //double   acc_gravity_z_array[64];
  40          //// fft_data
  41          //// body
  42          //double   fft_body_x_array[128];
  43          //double   fft_body_y_array[128];
  44          //double   fft_body_z_array[128];
  45          //// gravity
  46          //double  fft_gravity_x_array[128];
  47          //double  fft_gravity_y_array[128];
  48          //double  fft_gravity_z_array[128];
  49          //// total
  50          //double   fft_total_x_array[128];
  51          //double   fft_total_y_array[128];
  52          //double   fft_total_z_array[128];
  53          //// gyro
  54          //double   fft_gyro_x_array[128];
C51 COMPILER V9.59.0.0   MAIN                                                              06/18/2020 23:19:30 PAGE 2   

  55          //double   fft_gyro_y_array[128];
  56          //double   fft_gyro_z_array[128];
  57          // 用于测试（已删除）
  58          
  59          // 巴特沃斯滤波器所用缓存的数组
  60          double  xBuf[4] ={0};
  61          double  yBuf[4] ={0};
  62          // 滤波器的系数
  63          double xdata noise_b[4] = {0.52762438, 1.58287315, 1.58287315, 0.52762438};
  64          double xdata noise_a[4] = {1, 1.76004188, 1.18289326, 0.27805992};
  65          //double xdata get_gravity_b[4] ={6.45184913e-06, 1.93555474e-05, 1.93555474e-05, 6.45184913e-06};
  66          //double xdata get_gravity_a[4] ={1, -2.92460624, 2.85202782, -0.92736997};
  67          double xdata get_body_b[4] ={0.9630005, -2.88900151, 2.88900151, -0.9630005};
  68          double xdata get_body_a[4] ={1.       , -2.92460624, 2.85202782, -0.92736997};
  69          double xdata weight_array[10][36]=
  70          {
  71          {0.0490521810247826,-0.1372834754818557,-0.17732965800463507,0.04917798950541119,-4.313309311321234e-05,0.
             -40609648966884143,-0.10873203322784875,-0.13046148147356718,0.14599228901627903,-0.0018679322241634821,-0.22989050653899
             -606,-1.3793288722910315,-0.9352896251441605,1.346752276823751,-0.13950985957678164,-0.1361507833391138,-0.94408966365469
             -38,-1.177838588780884,0.8516013014406987,-0.08538989927937557,0.21075498911866575,-0.6639979188887217,-0.589568848469350
             -6,0.9176474136456454,-0.05383511949179631,-0.06174861717870472,-0.14739472931851605,-0.1869805751112441,0.21462311547930
             -657,-0.006417626867428083,-0.01452455973123623,-0.12304234435608041,0.11418828548864823,-0.6839169596261678,0.2390203264
             -0986004,-0.045852901129157964},
  72          {-0.0051019724780341225,-0.05945783768364816,-0.05839805012005541,0.051829620688480765,-0.0581176937596844
             -,-0.005705971534195647,-0.025459886204722323,-0.0253279932249652,0.03629328112868525,-0.007557540682827632,-0.0039325264
             -97594298,-0.04667107026806062,-0.04794763895601713,0.03430335197565172,-0.03055167480660435,-0.027743725964256692,-0.038
             -612475988855,-0.04077323985248468,0.04273413736603045,-0.022071933375474265,-0.05624698356364572,-0.04655904225888868,-0
             -.05018819897988194,0.039048648681428745,-0.03637306104293922,-0.00660965282892762,-0.05386454210584107,-0.04630038901582
             -126,0.05340074807901095,-0.04469983045742902,-0.025765196411999636,0.007819596426132079,-0.028933602170508534,-0.0243744
             -790652119,0.018000426371286814,0.019313174219316984},
  73          {-2.3415292937384248e-05,-0.04820422136547592,-0.03636974391937797,0.04736226936153771,-0.0340114189733990
             -16,-0.004451234512171137,-0.06059463149380803,-0.06943004128057963,0.05110468806686726,-0.036440896442106574,0.000715093
             -8890149797,-0.029244441062039415,-0.02414078782512975,0.03384090920518811,-0.010724615236575174,-0.04341939160751976,-0.
             -039232335139781284,-0.04359993259335372,0.03292187939685616,-0.020740819929181253,-0.03234839088477146,-0.04566059799276
             -684,-0.04167013484975411,0.045407350518410376,-0.02781414107601121,0.017941230957881672,-0.06863624585428613,-0.07035998
             -142732532,0.07809345150675437,-0.0639968422006494,-0.004351059767254978,0.00013142243968974898,0.01819065100083248,-0.02
             -780573540313802,0.006706770450656612,0.0301290967031213},
  74          {-0.006905449314187283,-0.13338232978919617,-0.0971384696527621,0.15000222057449558,-0.049255729851741745,
             -0.008805773739418455,-0.07470589984197758,-0.07917444843805616,0.1295865417896791,-0.01095970000265356,-0.02288449791030
             -5526,-0.0571192087995952,-0.053976414856780286,0.09415103526697172,-0.008431779849452148,-0.0049867044259796905,-0.14333
             -533376272223,-0.1363181190674541,0.16034961124469274,-0.04965956785768835,-0.02380020028947094,-0.12462790721940697,-0.1
             -83842229714624,0.11755361568415858,-0.04046790300728666,0.0006604040560706098,-0.14291556896399873,-0.1653766753888378,0
             -.1486420839501192,-0.05143984397677523,0.06349292489029981,-0.045738375515044324,0.03222478021327885,0.01832421409094267
             -5,0.11940343044686157,0.024355632578184176},
  75          {-0.01060282926439093,-0.065520597381377,-0.06655625965534374,0.059542551828511134,-0.06755235431454157,-0
             -.005764429193227258,-0.027717845535849488,-0.027489897544493564,0.04091769835550951,-0.008591650409280761,-0.00014473366
             -52266732,-0.05239017895363461,-0.05531137679365203,0.03648229713737936,-0.03879897788273796,-0.027003761026579014,-0.042
             -499059542032855,-0.041343019592599214,0.0426387055038779,-0.02950024145799493,-0.061393056693220746,-0.048744699366082,-
             -0.05024688445245935,0.04008043800224824,-0.04323657842696332,-0.0074325715742939325,-0.060441160959778466,-0.05287854091
             -259482,0.05803052010472865,-0.0516268302248079,-0.015484126477180076,0.021089452263100373,-0.019178298090998712,-0.01147
             -1230228756995,0.03614622802370721,0.011844364186738537},
  76          {-0.005471014098069796,-0.050814952836150944,-0.03857548756067715,0.05244497283981252,-0.03947697434400708
             -,-0.004702178209536012,-0.0691614279441865,-0.07564464788280623,0.06097708995175915,-0.04360864563161354,-0.002070318841
             -619894,-0.026991245057769064,-0.020704432257108017,0.033380680484032865,-0.011516481857244276,-0.04305882035871284,-0.03
             -8771831427115204,-0.03966175040221219,0.03296500024745409,-0.024224060122268624,-0.0390962516690257,-0.04242613801012682
             -,-0.03799420022014608,0.043008461795043355,-0.029863034613981144,0.019572222397743342,-0.07589195765083806,-0.0797650666
             -8605066,0.08329805960014483,-0.07333654072428025,0.006550454857342933,-0.0010960431457285348,0.04221457407758747,-0.0025
             -49680325579149,0.012435731375217186,0.021380877109746326},
  77          {-0.03589807794956525,-0.1630710547116506,-0.12182473209983401,0.17685261475978517,-0.06684476341983547,-0
             -.022006103190386504,-0.09145795472027692,-0.09321062843459162,0.1647489155536198,-0.014709783472911242,-0.00339232069875
             -6328,-0.034002796694502596,-0.0378359431004921,0.08816901085151556,-0.008843445259961724,-0.044118755707558785,-0.146250
             -37385160428,-0.1391721979820678,0.1598599821330688,-0.06712382682107669,0.008925890019637006,-0.13129892051213787,-0.203
C51 COMPILER V9.59.0.0   MAIN                                                              06/18/2020 23:19:30 PAGE 3   

             -27994469137314,0.13803711854529768,-0.05379348908052195,0.02468982587105889,-0.1758024412939316,-0.19599404157588834,0.1
             -8136060465210402,-0.0696133026212469,0.13607233546321776,-0.08025129552926635,0.06609592479753192,0.0008003684317827442,
             -0.039933569330043966,0.08887576973555047},
  78          {-0.005422203921816214,0.09577143126608774,0.1289134686389143,-0.03594201553541336,0.16723568701920774,-0.
             -003855669890931432,-0.12493859457977194,-0.17088324466959748,0.04671942135125384,-0.13456534105966506,-0.008845193023055
             -85,0.11857029357132373,0.1390720165282464,-0.052830214732176146,0.13293519620597322,-0.020830663555942264,-0.01627268809
             -181573,-0.03393110466426846,-0.022616416276138945,-0.058097223202366516,0.08981700822783725,0.06010785934549254,0.043568
             -08719385712,-0.05285124216942877,0.08537367661157151,0.028004927399747033,-0.04124747000937046,-0.1142357097458181,0.104
             -26222802268521,-0.06942399417081391,0.12352673059166056,-0.04715538547218434,0.24250067308515483,0.01845010748163653,0.0
             -19130518878713754,0.0035227021591126284},
  79          {0.020393456520576066,0.09575156301021644,0.11951515800849316,-0.0707261679779495,0.13688783753831288,0.02
             -133828923072912,0.03192028660185819,0.02986864578899592,-0.03604832932610831,0.014615306636021511,-0.009412659702896974,
             -0.09511350393630136,0.0927954676903767,-0.042699596839529355,0.09185551669835909,0.03404554332852311,0.02204451561415620
             -6,-0.01092793345087855,0.012092662567223501,0.028414490135787777,0.15143261266255537,0.06537826721245707,0.0470115007599
             -1789,-0.04016800246588058,0.07816922418488575,0.047589497495341734,0.07847856043316392,0.0428691347755942,-0.05009537562
             -567341,0.09435262265069458,0.10424195286996385,-0.03555349884838155,0.11762347641814679,0.027469786039708052,-0.06932752
             -533026759,-0.04201439872499072},
  80          {0.03912685269638942,0.04972003111316619,0.053565250066431085,-0.027820111749277187,0.057052897019674684,0
             -.021289441205328427,0.15411175590517506,0.17938758217330725,-0.12219281426652315,0.11809477676595168,-0.0155566153576190
             -24,0.028029030246079167,0.020043456731914294,0.007816024381547774,0.0175892475699959,0.10109200844226965,0.0171132638124
             -8339,0.007164138761603524,0.05255488260515762,0.02148978992314061,0.09718911336686964,0.05600114213717217,0.016243718320
             -936254,-0.04580232655238634,0.05077917195984766,-0.022753427000426624,0.12286535781141039,0.11001850734459846,-0.1271097
             -453401463,0.16412114755675689,0.06869662279132072,0.021337735541532732,-0.05096126860604487,0.0013887583579180844,0.0087
             -96033037810042,-0.05041029122098787},
  81          };
  82          double xdata bias_array[10]={
  83          -11.602085418595143
  84          ,-0.17438963805667312
  85          ,-0.16633029364901694
  86          ,-1.6122598727527107
  87          ,-0.10877781542863603
  88          ,-0.07662616381233227
  89          ,-1.5501864923497202
  90          ,0.10255859549070778
  91          ,-0.4742974681774877
  92          ,-0.668582104147141
  93          };
  94          //均值、标准差
  95          double xdata mean_data[36] = {-0.000848082,1.491349155,3.352941196,-3.071212364,3.812339829,0.001433263,1.
             -033136849,1.904073532,-2.357942898,2.522610729,0.001425372,0.871559484,2.061432731,-1.906268223,1.371106373,0.166679279,
             -1.835795717,3.777724293,-4.929736712,5.670622486,0.479643802,1.724965038,4.11756302,-3.459243714,5.573289468,0.185306112
             -,4.347485303,7.073353618,-6.491234488,33.48977482,0.108606525,0.233726233,0.239421925,-0.092766103,-0.264859274,-0.41163
             -2551};
  96          double xdata std_data[36] = {0.107699993,1.25563431,3.072784663,2.474958714,3.794511442,0.069204627,1.2043
             -45319,2.065966594,2.351320973,5.111051722,0.069276834,0.778902515,1.941017456,1.627875724,1.727696973,0.27487453,1.48227
             -48,2.943163899,3.921317837,6.214487812,0.554701439,1.435281582,3.283096114,2.851586245,6.032243192,0.399117089,3.7941420
             -05,6.144691253,5.527890877,37.00878282,0.467734673,0.399219282,0.501213167,0.356292286,0.371497178,0.384599173};
  97          //
  98          double xdata result_array[10]={0};
  99          int  likely_array[5];
 100          double  feature[36]={0};
 101          
 102          
 103          uint8 i;
 104          uint8 j;
 105          uint8 result[5]={0};
 106          int bignum = 0;
 107          uint8 index = 0;
 108          /**************************************
 109          功能描述：LCD1602写命令函数 
 110          入口参数uint8 com
 111          返回值：无
C51 COMPILER V9.59.0.0   MAIN                                                              06/18/2020 23:19:30 PAGE 4   

 112          ***************************************/
 113          void lcd_wcom(uint8 com)                 
 114          { 
 115   1          rs=0;               //选择指令寄存器 
 116   1          rw=0;               //选择写 
 117   1          P6=com;             //把命令字送入P2 
 118   1          delay_ms(1);        //延时一小会儿，让1602准备接收数据 
 119   1          en=1;               //使能线电平变化，命令送入1602的8位数据口 
 120   1          en=0; 
 121   1      } 
 122          
 123          /**************************************
 124          功能描述：LCD1602写数据函数 
 125          入口参数：uint8 dat
 126          返回值：无
 127          ***************************************/
 128          void lcd_wdat(uint8 dat)          
 129          { 
 130   1          rs=1;               //选择数据寄存器 
 131   1          rw=0;               //选择写 
 132   1          P6=dat;             //把要显示的数据送入P2 
 133   1          delay_ms(1);        //延时一小会儿，让1602准备接收数据 
 134   1          en=1;               //使能线电平变化，数据送入1602的8位数据口 
 135   1          en=0; 
 136   1      } 
 137          
 138          /**************************************
 139          功能描述：LCD1602初始化函数 
 140          入口参数：无
 141          返回值：无
 142          ***************************************/
 143          void lcd_init(void)                 
 144          { 
 145   1          lcd_wcom(0x38);       //8位数据，双列，5*7字形 
 146   1          delay_ms(20);
 147   1          lcd_wcom(0x38);
 148   1          delay_ms(20); 
 149   1          lcd_wcom(0x38); 
 150   1          lcd_wcom(0x0c);       //开启显示屏，关光标，光标不闪烁 
 151   1          lcd_wcom(0x06);       //显示地址递增，即写一个数据后，显示位置右移一位 
 152   1          lcd_wcom(0x01);       //清屏 
 153   1      }     
 154          
 155          /**************************************
 156          功能描述：LCD1602按指定位置显示一个字符
 157          入口参数：uint8 X, uint8 Y, uint8 DData
 158          返回值：无
 159          ***************************************/
 160          void DisplayOneChar( uint8 X,uint8 Y, uint8 DData)
 161          {
 162   1        Y &= 0x1;
 163   1        X &= 0xF; //限制X不能大于15，Y不能大于1
 164   1        if (Y) X |= 0x40; //当要显示第二行时地址码+0x40;
 165   1        X |= 0x80; //算出指令码
 166   1        lcd_wcom(X); //发命令字
 167   1        lcd_wdat(DData); //发数据
 168   1      }
 169          
 170          /**************************************
 171          功能描述：LCD1602按指定位置显示一串字符
 172          入口参数：uint8 X, uint8 Y, uint8 DData  X代表第X+1列，Y代表第Y+1行
 173          返回值：无
C51 COMPILER V9.59.0.0   MAIN                                                              06/18/2020 23:19:30 PAGE 5   

 174          ***************************************/
 175          void DisplayListChar(uint8 Y, uint8 X, uint8  *DData)
 176          {
 177   1        uint8 ListLength;
 178   1      
 179   1        ListLength = 0;
 180   1        Y &= 0x1;
 181   1        X &= 0xF; //限制X不能大于15，Y不能大于1
 182   1        while (DData[ListLength]>0x19) //若到达字串尾则退出
 183   1          {
 184   2            if (X <= 0xF)        //X坐标应小于0xF
 185   2              {
 186   3                DisplayOneChar(X, Y, DData[ListLength]); //显示单个字符
 187   3                ListLength++;
 188   3                X++;
 189   3              }
 190   2          }
 191   1      }
 192          /*********************************************************************************************************
             -***********************************
 193          // 计算统计量函数
 194          /********************************************************************************/
 195          double get_mean(double squence[], int len)
 196          {
 197   1        uint8 xdata i;
 198   1        double xdata output = 0;
 199   1        for(i=0;i<len;i++)
 200   1        {
 201   2          output+=squence[i];
 202   2        }
 203   1        return output/len;
 204   1      }
 205          double get_std(double squence[],int len)
 206          {
 207   1          double xdata mean = get_mean(squence,len);
 208   1          double xdata output = 0;
 209   1          uint8 xdata i;
 210   1          for (i = 0; i < len; i++) 
 211   1          {
 212   2            output += pow((squence[i] - mean), 2);
 213   2          }
 214   1          output = (output / len);
 215   1          return pow(output, 0.5);
 216   1      }
 217          double get_min(double squence[],int len)
 218          { 
 219   1        uint8 xdata i;
 220   1        double xdata output = squence[0];
 221   1        for (i=0;i<len;i++)
 222   1        {
 223   2          if(squence[i]<output)
 224   2          {
 225   3            output = squence[i];
 226   3          }
 227   2        }
 228   1        return output;
 229   1      }
 230          double get_max(double squence[],int len)
 231          { 
 232   1        uint8 xdata i;
 233   1        double xdata output = squence[0];
 234   1        for (i=0;i<len;i++)
C51 COMPILER V9.59.0.0   MAIN                                                              06/18/2020 23:19:30 PAGE 6   

 235   1        {
 236   2          if(squence[i]>output)
 237   2          {
 238   3            output = squence[i];
 239   3          }
 240   2        }
 241   1        return output;
 242   1      }
 243          double get_energy(double squence[],int len) 
 244          {
 245   1        uint8 xdata i;
 246   1        double xdata output = 0;
 247   1        for (i = 0; i < len; i++) 
 248   1        {
 249   2          output += pow(squence[i], 2);
 250   2        }
 251   1        return output / len;
 252   1      }
 253          double get_corrcoef(double data1[],int len1,double data2[],int len2)
 254          {
 255   1        uint8 xdata i;
 256   1        double xdata mean1 = get_mean(data1,len1);
 257   1        double xdata mean2 = get_mean(data2,len2);
 258   1        double xdata std1 =   get_std(data1,len1);
 259   1        double xdata std2 =   get_std(data2,len2);
 260   1        double xdata ab = 0;
 261   1        double xdata cov;
 262   1        for (i = 0; i < len1; i++) 
 263   1        {
 264   2          ab += data1[i] * data2[i];
 265   2        }
 266   1        ab = ab / len1;
 267   1        cov = ab - (mean1 * mean2);
 268   1        cov = cov / (std1 * std2);
 269   1        return cov;
 270   1      }
 271          /*********************************************************************************************************
             -***********************************
 272          ////******************************************************************************************************
             -**************************************
 273          //// 滤波函数
 274          ////********************************************************************************
 275          //// 中值滤波
 276          //// 第一个元素
 277          //void single_midian_first(double inputdata[])
 278          //{
 279          //  if(inputdata[0]*inputdata[1]<=0)
 280          //  {
 281          //    temp_signal[0]=0;
 282          //  }
 283          //  else
 284          //  {
 285          //    if(pow(inputdata[0],2)-pow(inputdata[1],2)>0)
 286          //      {temp_signal[0]=inputdata[1];}
 287          //    else
 288          //      {temp_signal[0]=inputdata[0];}
 289          //  }
 290          //}
 291          //// 最后一个元素
 292          //void single_midian_last(double inputdata[],int i)
 293          //{
 294          //  if(inputdata[i]*inputdata[i-1]<=0)
C51 COMPILER V9.59.0.0   MAIN                                                              06/18/2020 23:19:30 PAGE 7   

 295          //  {
 296          //    temp_signal[i]=0;
 297          //  }
 298          //  else
 299          //  {
 300          //    if(pow(inputdata[i],2)-pow(inputdata[i-1],2)>0)
 301          //      {temp_signal[i]=inputdata[i-1];}
 302          //    else
 303          //      {temp_signal[i]=inputdata[i];}
 304          //  }
 305          //}
 306          //// 其他元素
 307          //void single_midian_filter(double inputdata[],int i)
 308          //{
 309          //  temp_signal[i] = (inputdata[i-1]+inputdata[i]+inputdata[i+1])/3;
 310          //}
 311          //********************************************************************************************************
             -************************************/
 312          //  巴特沃斯低通滤波器（分开身体和重力数据）
 313          void init_buf_array(double*x,double*y)
 314          {
 315   1        *x=0; *++x=0; *++x=0; *++x=0;
 316   1        *y=0; *++y=0; *++y=0; *++y=0;
 317   1      }
 318          
 319          double low_pass_single_filter(double data_x,double a[],double b[])
 320          {
 321   1        uint8 xdata i,j;
 322   1        for (j = 3; j > 0; j--) {
 323   2            yBuf[j] = yBuf[j - 1];
 324   2            xBuf[j] = xBuf[j - 1];
 325   2          }
 326   1          xBuf[0] = data_x;
 327   1          yBuf[0] = 0;
 328   1          for (i = 1; i < 4; i++) {
 329   2            yBuf[0] = yBuf[0] + b[i] * xBuf[i];
 330   2            yBuf[0] = yBuf[0] - a[i] * yBuf[i];
 331   2          }
 332   1          yBuf[0] = yBuf[0] + b[0] * xBuf[0];
 333   1          return yBuf[0];
 334   1      }
 335          void low_pass_filter(double output[],double data_x[],double a[],double b[],int number)
 336          {
 337   1        uint8 xdata i;
 338   1        init_buf_array(xBuf,yBuf);
 339   1        for(i =0;i<number;i++)
 340   1        {
 341   2          output[i] = low_pass_single_filter(data_x[i],a,b);
 342   2        }
 343   1      }
 344          // fft
 345          void kfft(double output[],double pr[], int n, int k)
 346          {
 347   1        double xdata fr[64], fi[64];
 348   1        double xdata pi[64]={0};
 349   1        int xdata it, m, is, i, j, nv, l0;
 350   1        double xdata p, q, s, vr, vi, poddr, poddi;
 351   1        for (it=0;it<n;it++)  //将pr[0]和pi[0]循环赋值给fr[]和fi[]
 352   1        {
 353   2          m = it;
 354   2          is = 0;
 355   2          for (i=0;i<k;i++)
C51 COMPILER V9.59.0.0   MAIN                                                              06/18/2020 23:19:30 PAGE 8   

 356   2          {
 357   3            j = m/2;
 358   3            is = 2*is+(m-2*j);
 359   3            m = j;
 360   3          }
 361   2          fr[it] = pr[is];
 362   2          fi[it] = pi[is];
 363   2        }
 364   1        pr[0] = 1.0;
 365   1        pi[0] = 0.0;
 366   1        p = 6.283185306 / (1.0*n);
 367   1        pr[1] = cos(p); //将w=e^-j2pi/n用欧拉公式表示
 368   1        pi[1] = -sin(p);
 369   1      
 370   1        for(i=2;i<n;i++)  //计算pr[]
 371   1        {
 372   2          p = pr[i-1]*pr[1];
 373   2          q = pi[i-1]*pi[1];
 374   2          s =(pr[i-1]+pi[i-1])*(pr[1]+pi[1]);
 375   2          pr[i]=p-q;
 376   2          pi[i]=s-p-q;
 377   2        }
 378   1        for (it = 0; it <= n - 2; it = it + 2)
 379   1        {
 380   2          vr = fr[it];
 381   2          vi = fi[it];
 382   2          fr[it] = vr + fr[it + 1];
 383   2          fi[it] = vi + fi[it + 1];
 384   2          fr[it + 1] = vr - fr[it + 1];
 385   2          fi[it + 1] = vi - fi[it + 1];
 386   2        }
 387   1        m = n / 2;
 388   1        nv = 2;
 389   1        for (l0 = k - 2; l0 >= 0; l0--) //蝴蝶操作
 390   1        {
 391   2          m = m / 2;
 392   2          nv = 2 * nv;
 393   2          for (it = 0; it <= (m - 1)*nv; it = it + nv)
 394   2            for (j = 0; j <= (nv / 2) - 1; j++)
 395   2            {
 396   3              p = pr[m*j] * fr[it + j + nv / 2];
 397   3              q = pi[m*j] * fi[it + j + nv / 2];
 398   3              s = pr[m*j] + pi[m*j];
 399   3              s = s * (fr[it + j + nv / 2] + fi[it + j + nv / 2]);
 400   3              poddr = p - q;
 401   3              poddi = s - p - q;
 402   3              fr[it + j + nv / 2] = fr[it + j] - poddr;
 403   3              fi[it + j + nv / 2] = fi[it + j] - poddi;
 404   3              fr[it + j] = fr[it + j] + poddr;
 405   3              fi[it + j] = fi[it + j] + poddi;
 406   3            }
 407   2        }
 408   1        for (i = 0; i < n ; i++)
 409   1        {
 410   2          output[i] = sqrt(fr[i] * fr[i] + fi[i] * fi[i])/n;  //幅值计算
 411   2        }
 412   1        //return;
 413   1      }
 414          
 415          //********************************************************************************************************
             -************************************
 416          //********************************************************************************************************
C51 COMPILER V9.59.0.0   MAIN                                                              06/18/2020 23:19:30 PAGE 9   

             -************************************
 417          double get_acc_data(int sport_data)
 418          {
 419   1        acc_data  = sport_data;
 420   1        acc_data /= 2048;
 421   1        return acc_data;
 422   1      }
 423          double get_gyro_data(int sport_data)
 424          {
 425   1        gyro_data  = sport_data;
 426   1        gyro_data *= 0.001064;
 427   1        return gyro_data;
 428   1      }
 429          
 430          /***************************************************************************
 431           * 描  述 : 主函数
 432           * 入  参 : 无
 433           * 返回值 : 无
 434           **************************************************************************/
 435          
 436          
 437          
 438          int main()
 439          {       
 440   1        //AUXR |=0x02; // 使用拓展内存（目前暂时不需要）
 441   1        lcd_init();                          //液晶初始化 
 442   1        delay_ms(500);
 443   1        P3M1 &= 0xFE; P3M0 &= 0xFE;                   //设置P3.0为准双向口
 444   1        P3M1 &= 0xFD; P3M0 |= 0x02;                   //设置P3.1为推挽输出
 445   1        delay_ms(500);    //上电延时    
 446   1        UartInit();
 447   1        InitMPU6050();  //初始化MPU6050
 448   1        delay_ms(150);
 449   1      
 450   1        DisplayOneChar(1,0,0x30);
 451   1        DisplayOneChar(2,0,0x3A);
 452   1        DisplayOneChar(3,0,result[0]+0x30);
 453   1        
 454   1        
 455   1        DisplayOneChar(6,0,0x31);
 456   1        DisplayOneChar(7,0,0x3A);
 457   1        DisplayOneChar(8,0,result[1]+0x30);
 458   1          
 459   1        DisplayOneChar(11,0,0x32);
 460   1        DisplayOneChar(12,0,0x3A);
 461   1        DisplayOneChar(13,0,result[2]+0x30);
 462   1      
 463   1        
 464   1        DisplayOneChar(1,1,0x33);
 465   1        DisplayOneChar(2,1,0x3A);
 466   1        DisplayOneChar(3,1,result[3]+0x30);
 467   1        
 468   1      
 469   1        DisplayOneChar(6,1,0x34);
 470   1        DisplayOneChar(7,1,0x3A);
 471   1        DisplayOneChar(8,1,result[4]+0x30);
 472   1      
 473   1        
 474   1        while(1)
 475   1        {   
 476   2            if(key2==0)
 477   2            {       
C51 COMPILER V9.59.0.0   MAIN                                                              06/18/2020 23:19:30 PAGE 10  

 478   3              delay_ms(500);    
 479   3              led1=0;
 480   3              // 获取数据
 481   3              for(i=0;i<64;i++)
 482   3              {
 483   4                delay_ms(30);
 484   4                acc_x_array[i]  = get_acc_data(GetData(ACCEL_XOUT_H));
 485   4                acc_y_array[i]  = get_acc_data(GetData(ACCEL_YOUT_H));
 486   4                acc_z_array[i]  = get_acc_data(GetData(ACCEL_ZOUT_H));          
 487   4                gyro_x_array[i] = get_gyro_data(GetData(GYRO_XOUT_H));
 488   4                gyro_y_array[i] = get_gyro_data(GetData(GYRO_YOUT_H));
 489   4                gyro_z_array[i] = get_gyro_data(GetData(GYRO_ZOUT_H));
 490   4              }
 491   3              led1=1;
 492   3              
 493   3      //        // 分别获取身体和重力数据 + 角速度滤波
 494   3          
 495   3                low_pass_filter(acc_x_array,     acc_x_array, noise_a,     noise_b,    64);
 496   3                low_pass_filter(acc_y_array,     acc_y_array, noise_a,     noise_b,    64);
 497   3                low_pass_filter(acc_z_array,     acc_z_array, noise_a,     noise_b,    64);
 498   3                low_pass_filter(gyro_x_array,    gyro_x_array,noise_a,     noise_b,    64);
 499   3                low_pass_filter(gyro_y_array,    gyro_y_array,noise_a,     noise_b,    64);
 500   3                low_pass_filter(gyro_z_array,    gyro_z_array,noise_a,     noise_b,    64);
 501   3                low_pass_filter(acc_body_x_array,    acc_x_array, get_body_a,    get_body_b,     64);
 502   3                low_pass_filter(acc_body_y_array,    acc_y_array, get_body_a,    get_body_b,     64);
 503   3                low_pass_filter(acc_body_z_array,    acc_z_array, get_body_a,    get_body_b,     64);
 504   3      //          low_pass_filter(acc_gravity_x_array, acc_x_array, get_gravity_a, get_gravity_b, 64);
 505   3      //          low_pass_filter(acc_gravity_y_array, acc_y_array, get_gravity_a, get_gravity_b, 64);
 506   3      //          low_pass_filter(acc_gravity_z_array, acc_z_array, get_gravity_a, get_gravity_b, 64);
 507   3              
 508   3      //        // FFT
 509   3      //        kfft(fft_body_x_array,    acc_body_x_array,    128, 7);
 510   3      //        kfft(fft_body_y_array,    acc_body_y_array,    128, 7);
 511   3      //        kfft(fft_body_z_array,    acc_body_z_array,    128, 7);
 512   3      //        kfft(fft_gravity_x_array, acc_gravity_x_array, 128, 7);
 513   3      //        kfft(fft_gravity_y_array, acc_gravity_y_array, 128, 7);
 514   3      //        kfft(fft_gravity_z_array, acc_gravity_z_array, 128, 7);
 515   3      //        kfft(fft_total_x_array,   acc_x_array,         128, 7);
 516   3      //        kfft(fft_total_y_array,   acc_y_array,         128, 7);
 517   3      //        kfft(fft_total_z_array,   acc_z_array,         128, 7);
 518   3      //        kfft(fft_gyro_x_array,    gyro_x_array,        128, 7);
 519   3      //        kfft(fft_gyro_y_array,    gyro_y_array,        128, 7);
 520   3      //        kfft(fft_gyro_z_array,    gyro_z_array,        128, 7);
 521   3      
 522   3              // 特征提取
 523   3              //0-14
 524   3              // acc_body_x
 525   3              feature[0] = get_mean(acc_body_x_array,64);
 526   3              feature[1] = get_std(acc_body_x_array,64);
 527   3              feature[2] = get_min(acc_body_x_array,64);
 528   3              feature[3] = get_max(acc_body_x_array,64);
 529   3              feature[4] = get_energy(acc_body_x_array,64);
 530   3              // acc_body_y
 531   3              feature[5] = get_mean(acc_body_y_array,64);
 532   3              feature[6] = get_std(acc_body_y_array,64);
 533   3              feature[7] = get_min(acc_body_y_array,64);
 534   3              feature[8] = get_max(acc_body_y_array,64);
 535   3              feature[9] = get_energy(acc_body_y_array,64);
 536   3              // acc_body_z
 537   3              feature[10] = get_mean(acc_body_z_array,64);
 538   3              feature[11] = get_std(acc_body_z_array,64);
 539   3              feature[12] = get_min(acc_body_z_array,64);
C51 COMPILER V9.59.0.0   MAIN                                                              06/18/2020 23:19:30 PAGE 11  

 540   3              feature[13] = get_max(acc_body_z_array,64);
 541   3              feature[14] = get_energy(acc_body_z_array,64);
 542   3              
 543   3              //15-29
 544   3              //gyro_x
 545   3              feature[15] = get_mean(gyro_x_array,64);
 546   3              feature[16] = get_std(gyro_x_array,64);
 547   3              feature[17] = get_min(gyro_x_array,64);
 548   3              feature[18] = get_max(gyro_x_array,64);
 549   3              feature[19] = get_energy(gyro_x_array,64);
 550   3              //gyro_y
 551   3              feature[20] = get_mean(gyro_y_array,64);
 552   3              feature[21] = get_std(gyro_y_array,64);
 553   3              feature[22] = get_min(gyro_y_array,64);
 554   3              feature[23] = get_max(gyro_y_array,64);
 555   3              feature[24] = get_energy(gyro_y_array,64);
 556   3              //gyro_z
 557   3              feature[25] = get_mean(gyro_z_array,64);
 558   3              feature[26] = get_std(gyro_z_array,64);
 559   3              feature[27] = get_min(gyro_z_array,64);
 560   3              feature[28] = get_max(gyro_z_array,64);
 561   3              feature[29] = get_energy(gyro_z_array,64);  
 562   3        
 563   3              // acc_body_correlation
 564   3              feature[31] = get_corrcoef(acc_body_x_array,64,acc_body_y_array,64);
 565   3              feature[32] = get_corrcoef(acc_body_y_array,64,acc_body_z_array,64);
 566   3              feature[33] = get_corrcoef(acc_body_x_array,64,acc_body_z_array,64);
 567   3              // gyro_correlation
 568   3              feature[34] = get_corrcoef(gyro_x_array,64,gyro_y_array,64);
 569   3              feature[35] = get_corrcoef(gyro_x_array,64,gyro_z_array,64);
 570   3              feature[36] = get_corrcoef(gyro_y_array,64,gyro_z_array,64);
 571   3      
 572   3      
 573   3              
 574   3              // 标准化
 575   3              for(i=0;i<36;i++)
 576   3              {
 577   4                feature[i] -= mean_data[i];
 578   4                feature[i] /= std_data[i];
 579   4              }
 580   3              // 开始svm分类
 581   3              for(i=0;i<10;i++)
 582   3              {
 583   4                result_array[i]=0;
 584   4                for(j=0;j<36;j++)
 585   4                {
 586   5                  result_array[i] += weight_array[i][j]*feature[j];
 587   5                }
 588   4                result_array[i] += bias_array[i];
 589   4              }
 590   3      
 591   3              U1SendData(0x0d);                          //换行
 592   3              U1SendData(0x0a);                          //回车
 593   3              //0,1化
 594   3              for(i=0;i<10;i++)
 595   3              {
 596   4                  if(result_array[i]>0)
 597   4                  {
 598   5                    result_array[i]=1;
 599   5                  }
 600   4                  else
 601   4                  {
C51 COMPILER V9.59.0.0   MAIN                                                              06/18/2020 23:19:30 PAGE 12  

 602   5                    result_array[i]=0;
 603   5                  }
 604   4              }
 605   3              likely_array[0] =     result_array[0] + result_array[1] + result_array[2] + result_array[3];
 606   3              likely_array[1] = 1 - result_array[0] + result_array[4] + result_array[5] + result_array[6];
 607   3              likely_array[2] = 2 - result_array[1] - result_array[4] + result_array[7] + result_array[8];
 608   3              likely_array[3] = 3 - result_array[2] - result_array[5] - result_array[7] + result_array[8];
 609   3              likely_array[4] = 4 - result_array[3] - result_array[6] - result_array[8] - result_array[9];
 610   3      //        Display10BitData(likely_array[0]);
 611   3      //        Display10BitData(likely_array[1]);
 612   3      //        Display10BitData(likely_array[2]);
 613   3      //        Display10BitData(likely_array[3]);
 614   3      //        Display10BitData(likely_array[4]);
 615   3      //        U1SendData(0x0d);                          //换行
 616   3      //        U1SendData(0x0a);                          //回车
 617   3              bignum = likely_array[0];
 618   3              index = 0;
 619   3              for(i=0;i<5;i++)
 620   3              {
 621   4                if(likely_array[i] >bignum)
 622   4                {
 623   5                  bignum = likely_array[i];
 624   5                  index = i;
 625   5                }
 626   4              }
 627   3              result[index] += 1;
 628   3      //        for(i=0;i<5;i++)
 629   3      //        {
 630   3      //          if(likely_array[i]==4)
 631   3      //          {
 632   3      //            result[i] += 1;
 633   3      //          }
 634   3      //        }
 635   3      
 636   3              DisplayOneChar(3,0,likely_array[0]+0x30);
 637   3              DisplayOneChar(8,0,likely_array[1]+0x30);
 638   3              DisplayOneChar(13,0,likely_array[2]+0x30);
 639   3              DisplayOneChar(3,1,likely_array[3]+0x30);
 640   3              DisplayOneChar(8,1,likely_array[4]+0x30);
 641   3            
 642   3              U1SendData(0x0d);                          //换行
 643   3              U1SendData(0x0a);                          //回车
 644   3      
 645   3          }
 646   2          if(key1==0)
 647   2          {     
 648   3            delay_ms(500);
 649   3            result[0] = 0;
 650   3            result[1] = 0;
 651   3            result[2] = 0;
 652   3            result[3] = 0;
 653   3            result[4] = 0;
 654   3            DisplayOneChar(1,0,0x30);
 655   3            DisplayOneChar(2,0,0x3A);
 656   3            DisplayOneChar(3,0,result[0]+0x30);
 657   3                
 658   3            DisplayOneChar(6,0,0x31);
 659   3            DisplayOneChar(7,0,0x3A);
 660   3            DisplayOneChar(8,0,result[1]+0x30);
 661   3              
 662   3            DisplayOneChar(11,0,0x32);
 663   3            DisplayOneChar(12,0,0x3A);
C51 COMPILER V9.59.0.0   MAIN                                                              06/18/2020 23:19:30 PAGE 13  

 664   3            DisplayOneChar(13,0,result[2]+0x30);
 665   3      
 666   3            
 667   3            DisplayOneChar(1,1,0x33);
 668   3            DisplayOneChar(2,1,0x3A);
 669   3            DisplayOneChar(3,1,result[3]+0x30);
 670   3            
 671   3      
 672   3            DisplayOneChar(6,1,0x34);
 673   3            DisplayOneChar(7,1,0x3A);
 674   3            DisplayOneChar(8,1,result[4]+0x30);
 675   3          }
 676   2        }
 677   1      
 678   1      }  
 679                  
 680          
 681          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   8674    ----
   CONSTANT SIZE    =    256    ----
   XDATA SIZE       =   4380     948
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
